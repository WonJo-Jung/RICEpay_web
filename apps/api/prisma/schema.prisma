
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Transaction {
  id             String   @id @default(cuid())
  chainId        Int
  network        String
  txHash         String   @unique
  from           String
  to             String
  token          String?
  amount         String?
  status         String   // PENDING | CONFIRMED | FAILED | DROPPED_REPLACED | UNKNOWN
  blockNumber    Int?
  confirmations  Int?     @default(0)
  lastEventId    String?  @unique
  rawPayload     Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Receipt {
  id              String   @id @default(cuid())
  transactionId   String   @unique
  chainId         Int
  network         String   // "BASE" | "ETHEREUM" | ...
  txHash          String
  direction       String   // "SENT" | "RECEIVED"
  token           String   // "USDC"
  amount          Decimal
  // ìŠ¤ëƒ…ìƒ·ë“¤ (í™•ì • ì‹œì )
  fiatCurrency    String   // "USD"
  fiatRate        Decimal  // rate at confirmation
  fiatAmount      Decimal  // amount * rate
  gasPaid         Decimal? // native unit at confirmation
  gasFiatAmount   Decimal? // gas * nativeUSD
  appFee          Decimal? // token unit
  appFeeFiat      Decimal?
  policyVersion   String
  fromAddress     String
  toAddress       String
  submittedAt     DateTime
  confirmedAt     DateTime
  shareToken      String?  @unique
  snapshot        Json     // ê¸°íƒ€: appVersion, locale, usdSource, confirmations ë“±
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([fromAddress])
  @@index([toAddress])
  @@index([confirmedAt])
}

model ReceiptAudit {
  id          String   @id @default(cuid())
  receiptId   String
  actorUserId String?
  action      String   // 'ISSUE' | 'REUSE' | 'ROTATE' | 'REVOKE' | 'REVOKE_NOOP' | 'REVOKE_STALE' | 'REVOKE_DRYRUN' | 'REVOKE_RACE_NOOP'
  ip          String?
  userAgent   String?
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([receiptId])
}

model SanctionedAddress {
  id        String   @id @default(cuid())
  chain     String
  address   String
  checksum  String   // âœ… EIP-55 ì •ê·œí™” ì£¼ì†Œ(ê²€ì¦ìš©)
  source    String   // "OFAC" | "EU" | "UN" | "TRM" | "MANUAL" ...
  reason    String?
  version   String?  // ì™¸ë¶€ ë™ê¸°í™” ë²„ì „ íƒœê¹…(ì¶”ì ì„±)
  updatedAt DateTime @updatedAt @default(now())
  createdAt DateTime @default(now())
  @@index([chain, address])
  @@unique([chain, address])
}

model BlockedCountry {
  code      String   @id // ISO-3166-1 alpha-2
  reason    String?
  updatedAt DateTime @updatedAt @default(now())
  createdAt DateTime @default(now())
}

model BlockedRegion {
  id        String   @id @default(cuid())
  country   String   // ì˜ˆ: "UA"
  region    String   // ì˜ˆ: "Crimea" | "Donetsk" | "Luhansk"
  pattern   String?  // ê³µê¸‰ìë³„ ì§€ì—­ ì½”ë“œ/ì´ë¦„ íŒ¨í„´(ì •ê·œì‹)
  reason    String?
  updatedAt DateTime @updatedAt @default(now())
  createdAt DateTime @default(now())
  @@index([country, region])
}

model ComplianceAudit {
  id        String   @id @default(cuid())
  type      String   // "GEOFENCE" | "SANCTIONS"
  status    String   // "ALLOWED" | "BLOCKED"
  rule      String?  // "COUNTRY:IR" | "REGION:UA/Crimea" | "ADDR:OFAC"
  version   String?  // ë¦¬ìŠ¤íŠ¸ ë²„ì „/ìŠ¤ëƒ…ìƒ·
  chain     String?
  address   String?
  ip        String?
  country   String?
  region    String?
  route     String?
  userId    String?
  meta      Json?
  createdAt DateTime @default(now())
  @@index([type, status, createdAt])
}

model SyncState {
  key               String   @id   // "SANCTIONS/PROVIDER"
  version           String?
  consecutiveNoop   Int      @default(0)       // ğŸ‘ˆ ì—°ì† 0ê±´ ì¹´ìš´í„°
  updatedAt         DateTime @updatedAt @default(now())
  createdAt         DateTime @default(now())
}
