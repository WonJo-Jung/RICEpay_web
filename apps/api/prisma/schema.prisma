
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Transaction {
  id             String   @id @default(cuid())
  chainId        Int
  network        String
  txHash         String   @unique
  from           String
  to             String
  token          String?
  amount         String?
  status         String   // PENDING | CONFIRMED | FAILED | DROPPED_REPLACED | UNKNOWN
  blockNumber    Int?
  confirmations  Int?     @default(0)
  lastEventId    String?  @unique
  rawPayload     Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Receipt {
  id              String   @id @default(cuid())
  transactionId   String   @unique
  chainId         Int
  network         String   // "BASE" | "ETHEREUM" | ...
  txHash          String
  direction       String   // "SENT" | "RECEIVED"
  token           String   // "USDC"
  amount          Decimal
  // 스냅샷들 (확정 시점)
  fiatCurrency    String   // "USD"
  fiatRate        Decimal  // rate at confirmation
  fiatAmount      Decimal  // amount * rate
  gasPaid         Decimal? // native unit at confirmation
  gasFiatAmount   Decimal? // gas * nativeUSD
  appFee          Decimal? // token unit
  appFeeFiat      Decimal?
  policyVersion   String
  fromAddress     String
  toAddress       String
  submittedAt     DateTime
  confirmedAt     DateTime
  shareToken      String?  @unique
  snapshot        Json     // 기타: appVersion, locale, usdSource, confirmations 등
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([fromAddress])
  @@index([toAddress])
  @@index([confirmedAt])
}

model ReceiptAudit {
  id          String   @id @default(cuid())
  receiptId   String
  actorUserId String?
  action      String   // 'ISSUE' | 'REUSE' | 'ROTATE' | 'REVOKE' | 'REVOKE_NOOP' | 'REVOKE_STALE' | 'REVOKE_DRYRUN' | 'REVOKE_RACE_NOOP'
  ip          String?
  userAgent   String?
  meta        Json?
  createdAt   DateTime @default(now())

  @@index([receiptId])
}
